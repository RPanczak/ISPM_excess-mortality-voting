---
title: "Excess mortality & voting patterns in CH"
subtitle: "Ancillary data preparation"
pagetitle: "Excess & voting: ancillary data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(haven, readxl,
       tidyverse, magrittr, janitor, scales, lubridate, 
       DT, 
       sf, tmap,
       swissdd)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)
```

<!-- ----------------------------------------------------- -->
<!-- ----------------------------------------------------- -->

# Population

Data extracted from [`px-x-0103010000_201`](https://www.pxweb.bfs.admin.ch/pxweb/de/px-x-0103010000_201/-/px-x-0103010000_201.px/):

> Ständige und nichtständige Wohnbevölkerung nach institutionellen Gliederungen, Staatsangehörigkeit (Kategorie), Geburtsort, Geschlecht und Altersklasse

Important info from footnotes:

> *Letzte Änderungen: Neuer Datensatz (Jahr 2020)*
> *Stand der Datenbank: Juni 2021*
> *Stichtag: 31. Dezember*
> **Raumbezug: Gemeinden / 18.10.2020**
> *Datenquelle: Statistik der Bevölkerung und der Haushalte STATPOP*
> *Definition der ständigen Wohnbevölkerung*

## Community codes

Community mutations data after `2021-01-01` from @Cordula are integrated into the data and pops are recalculated using these new codes to match mortality.  

```{r eval=FALSE, include=FALSE}
histcomm_14 <- read_excel("data-raw/BfS/Gemeindestand - Stand vom 01.07.2021.xlsx", 
                          col_types = c("numeric", "text", "skip", 
                                        "skip", "numeric", "text", "text")) %>%
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  mutate(datum_der_aufnahme = ymd(datum_der_aufnahme)) %>% 
  filter(datum_der_aufnahme >= ymd("2014-01-01") & 
           datum_der_aufnahme < ymd("2015-01-01")) %>% 
  arrange(datum_der_aufnahme, gemeindename)
```

```{r}
histcomm <- read_rds("data/BfS/histcomm.Rds") %>% 
  filter(datum_der_aufnahme >= ymd("2021-01-01")) %>% 
  select(bfs_gde_num_old, bfs_gde_num_new, gemeindename_new)
```

```{r eval=FALSE, include=FALSE}
datatable(histcomm)
```

Further corrections of municipalities mutations are needed to bring the data to the state of `2022-01-01`.  

## Data preps

Data aggregated to age groups as in deaths dataset. 

```{r}
population <- read_xlsx("data-raw/BfS/px-x-0103010000_201.xlsx", 
                        col_types = c("numeric", 
                                      "skip", "numeric", "text", "skip", 
                                      "skip", "skip", "text", "skip", "skip", 
                                      "skip", "text", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric"), 
                        skip = 1) %>%
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  rename(year = x1, 
         GMDNR = x2,
         GMDNAME = x3) %>% 
  mutate(sex = if_else(x5 == "Frau", "Female", "Male"),
         nationality = if_else(x4 == "Schweiz", "Swiss", "Foreigner"),
         year = as.integer(year)) %>% 
  select(-x4, -x5) %>% 
  relocate(sex, .after = GMDNAME) %>% 
  relocate(nationality, .after = sex) %>% 
  mutate(GMDNAME = word(GMDNAME, 2, -1)) %>% 
  fill(year, GMDNR, GMDNAME, nationality) %>% 
  mutate(`<40` = x0_4_jahre + x5_9_jahre + x10_14_jahre + x15_19_jahre + 
           x20_24_jahre + x25_29_jahre + x30_34_jahre + x35_39_jahre) %>% 
  select(-x0_4_jahre, -x5_9_jahre, -x10_14_jahre, -x15_19_jahre,  
         -x20_24_jahre, -x25_29_jahre, -x30_34_jahre, -x35_39_jahre) %>% 
  mutate(`40-49` = x40_44_jahre + x45_49_jahre) %>% 
  mutate(`50-59` = x50_54_jahre + x55_59_jahre) %>% 
  mutate(`60-69` = x60_64_jahre + x65_69_jahre) %>% 
  mutate(`70-79` = x70_74_jahre + x75_79_jahre) %>% 
  select(-x40_44_jahre, -x45_49_jahre, -x50_54_jahre, -x55_59_jahre,
         -x60_64_jahre, -x65_69_jahre, -x70_74_jahre, -x75_79_jahre) %>% 
  mutate(`80+` = x80_84_jahre +x85_89_jahre + x90_94_jahre +
           x95_99_jahre + x100_jahre_und_mehr) %>% 
  select(-x80_84_jahre, -x85_89_jahre, -x90_94_jahre,
         -x95_99_jahre, -x100_jahre_und_mehr) %>% 
  pivot_longer(cols = `<40`:`80+`, 
               names_to = "age", values_to = "population") %>% 
  
  # BfS identified changes
  left_join(histcomm, by = c("GMDNR" = "bfs_gde_num_old")) %>% 
  mutate(GMDNR = if_else(!is.na(bfs_gde_num_new), bfs_gde_num_new, GMDNR),
         GMDNAME = if_else(!is.na(gemeindename_new), gemeindename_new, GMDNAME)) %>% 
  select(-bfs_gde_num_new, -gemeindename_new) %>% 
  
  # Essertes merge
  mutate(GMDNR = if_else(GMDNAME == "Essertes", 5805, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Essertes", "Oron", GMDNAME)) %>% 
  
  # now to reach the state of `2022-01-01`
  mutate(GMDNR = if_else(GMDNAME == "Bad Zurzach", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Bad Zurzach", "Zurzach", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Baldingen", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Baldingen", "Zurzach", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Böbikon", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Böbikon", "Zurzach", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Kaiserstuhl", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Kaiserstuhl", "Zurzach", GMDNAME)) %>%
  mutate(GMDNR = if_else(GMDNAME == "Rekingen (AG)", 4324, GMDNR)) %>%
  mutate(GMDNAME = if_else(GMDNAME == "Rekingen (AG)", "Zurzach", GMDNAME)) %>%
  mutate(GMDNR = if_else(GMDNAME == "Rietheim", 4324, GMDNR)) %>%
  mutate(GMDNAME = if_else(GMDNAME == "Rietheim", "Zurzach", GMDNAME)) %>%
  mutate(GMDNR = if_else(GMDNAME == "Rümikon", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Rümikon", "Zurzach", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Wislikofen", 4324, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Wislikofen", "Zurzach", GMDNAME)) %>% 
  # Böztal merge
  mutate(GMDNR = if_else(GMDNAME == "Bözen", 4185, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Bözen", "Böztal", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Elfingen", 4185, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Elfingen", "Böztal", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Effingen", 4185, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Effingen", "Böztal", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Hornussen", 4185, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Hornussen", "Böztal", GMDNAME)) %>% 
  # Blonay - Saint-Légier merge
  mutate(GMDNR = if_else(GMDNAME == "Blonay", 5892, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Blonay", "Blonay - Saint-Légier", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Saint-Légier-La Chiésaz", 5892, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Saint-Légier-La Chiésaz", "Blonay - Saint-Légier", GMDNAME)) %>% 
  # Murten merge
  mutate(GMDNR = if_else(GMDNAME == "Galmiz", 2275, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Galmiz", "Murten", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Gempenach", 2275, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Gempenach", "Murten", GMDNAME)) %>% 
  mutate(GMDNR = if_else(GMDNAME == "Clavaleyres", 2275, GMDNR)) %>% 
  mutate(GMDNAME = if_else(GMDNAME == "Clavaleyres", "Murten", GMDNAME)) %>% 
  
  group_by(year, GMDNR, GMDNAME, sex, age) %>% 
  summarise(population = as.integer(sum(population))) %>% 
  ungroup() %>% 
  arrange(year, GMDNR, sex, age)
```

```{r include=FALSE}
rm(histcomm); gc()
```

Yearly totals (**on 31st Dec**!):  

```{r echo=FALSE}
population %>% 
  group_by(year) %>% 
  summarise(population = sum(population)) %>% 
  mutate(population = as.character(number(population, big.mark = ","))) 
```

Age (40 plus!) distributions over years  

```{r echo=FALSE}
population %>% 
  filter(age != "<40") %>% 
  group_by(year, age, sex) %>% 
  summarise(population = sum(population)) %>% 
  ungroup() %>% 
  ggplot(aes(x = age, y = population, fill = as.factor(year))) + 
  geom_col(position = "dodge") + 
  scale_fill_viridis_d() + 
  theme_minimal()
```

## Predicting 2020 & 2021 pops

```{r eval=FALSE, include=FALSE}
# smallest pops
population %>% 
  filter(year == 2020) %>% 
  group_by(GMDNR) %>% 
  summarize(population = sum(population),
            GMDNAME = first(GMDNAME)) %>% 
  ungroup() %>% 
  arrange(population)
# arrange(desc(population))
```

For each age, sex, nationality stratum, for each municipality separately, Poisson model was fitted using the 2014-2019 data; then prediction was made for 2020 & 2021 years. The gist of this operation was to exclude the effect of pandemic from the population counts in years affected.   

```{r}
population_ext_poi <- population %>% 
  filter(year != 2020) %>% 
  # filter(GMDNR == 261 | GMDNR == 389) %>%
  group_by(GMDNR, age, sex) %>% 
  do(glm(population ~ year, data = ., family = "poisson") %>%
       predict(., newdata = tibble(year = c(as.integer(2020), as.integer(2021))),                type = "response") %>%
       tibble(year = c(as.integer(2020), as.integer(2021)), 
              population_ext_poi = .)
  ) %>% 
  ungroup() %>% 
  mutate(population_ext_poi = as.integer(round(population_ext_poi))) %>% 
  arrange(year, GMDNR, sex, age) %>% 
  relocate(year)
```

Summary of values:  

```{r echo=FALSE}
summary(population_ext_poi$population_ext_poi)
```

**Note:** *4 NAs!*  

```{r echo=FALSE}
population %>% 
  filter(GMDNR %in% c(4232) & sex == "Male" & age == "80+")

population_ext_poi %>% 
  filter(GMDNR %in% c(4232) & sex == "Male" & age == "80+")

population %>% 
  filter(GMDNR %in% c(389) & sex == "Male" & age == "80+")

population_ext_poi %>% 
  filter(GMDNR %in% c(389) & sex == "Male" & age == "80+")
```

### Results in large municipality

Results for large municipality are fine. 
Predictions are in red.  

```{r echo=FALSE, warning=FALSE}
population %>% 
  filter(GMDNR == 261 & (age == "80+" | age == "<40")) %>% 
  bind_rows(population_ext_poi %>% 
              filter(GMDNR == 261 & (age == "80+" | age == "<40"))) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = population)) +
  geom_point(aes(y = population_ext_poi), color = "red") +
  facet_wrap(age~sex, scales = "free")
```

For small municipality we might end up with sth more wiggly. 

```{r echo=FALSE, warning=FALSE}
population %>% 
  filter(GMDNR == 389 & (age == "80+" | age == "<40")) %>% 
  bind_rows(population_ext_poi %>% 
              filter(GMDNR == 389 & (age == "80+" | age == "<40"))) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = population)) +
  geom_point(aes(y = population_ext_poi), color = "red") +
  facet_wrap(age~sex, scales = "free")
```

**Note:** *lack of prediction for 2020 & 2021 for oldest males!*  

There are two municipalities with missing predictions for oldest males:  

```{r echo=FALSE}
(problems <- population_ext_poi %>% 
   filter(is.na(population_ext_poi)) %>% 
   select(GMDNR, age, sex) %>% 
   left_join(population %>% 
               select(GMDNR, GMDNAME) %>% 
               distinct()) %>% 
   distinct())
```

```{r eval=FALSE, include=FALSE}
population %>% 
  bind_rows(population_ext_poi) %>% 
  filter(GMDNR %in% problems$GMDNR,
         age %in% problems$age,
         sex %in% problems$sex) %>%
  arrange(GMDNR, sex, age, year) %>%
  View()

population %>% 
  bind_rows(population_ext_lm) %>% 
  filter(GMDNR %in% problems$GMDNR,
         age %in% problems$age,
         sex %in% problems$sex) %>%
  arrange(GMDNR, sex, age, year) %>%
  View()
```

Population in this strata was replaced by estimates of a simple linear model.  

```{r include=FALSE}
population_ext_lm <- population %>%
  filter(year != 2020) %>%
  group_by(GMDNR, age, sex) %>%
  do(lm(population ~ year, data = .) %>%
       predict(., newdata = tibble(year = c(as.integer(2020), as.integer(2021)))) %>%
       tibble(
         year = c(as.integer(2020), as.integer(2021)),
         population_ext_lm = .
       )) %>%
  ungroup() %>%
  mutate(population_ext_lm = as.integer(round(population_ext_lm))) %>%
  arrange(year, GMDNR, sex, age) %>%
  relocate(year)
```

```{r}
population_complete <- population %>% 
  
  # NAs for first half of 2021
  bind_rows(
    population %>% 
      filter(year == 2020) %>% 
      mutate(year = 2021, population = NA_integer_)
  ) %>% 
  
  # extrapolated two years
  left_join(population_ext_poi) %>% 
  mutate(population_ext_poi = if_else(year < 2020, 
                                      population, population_ext_poi)) %>% 
  
  # replacing missings
  left_join(population_ext_lm) %>% 
  mutate(population_ext_poi = if_else(year >= 2020 & is.na(population_ext_poi), 
                                      population_ext_lm, population_ext_poi)) %>% 
  select(-population_ext_lm) 
```

## Getting mid-year pops

For each age, sex, nationality stratum, for each municipality separately, simple mean of the two years of data is used to estimate the middle point. In such case we use, for instance data from 31st Dec 2014 and 31st Dec 2015 to estimate population mid-2015.   

```{r}
for (i in 2014:2020){
  
  result <- population_complete %>% 
    filter(year >= i & year <= i + 1) %>% 
    # filter(GMDNR == 261 | GMDNR == 389) %>%
    group_by(GMDNR, age, sex) %>% 
    summarise(population_mid_poi = mean(population_ext_poi)) %>% 
    ungroup() %>% 
    mutate(year = as.integer(i + 1),
           population_mid_poi = as.integer(round(population_mid_poi))) %>% 
    arrange(GMDNR, sex, age) %>% 
    relocate(year)
  
  if (i == 2014) {
    population_mid_poi <- result
  } else {
    population_mid_poi <- bind_rows(population_mid_poi, result)
  }
  
}
```

```{r include=FALSE}
table(population_complete$year)
table(population_mid_poi$year)

rm(i, result, population, population_ext_lm, population_ext_poi); gc()
```

### Large municipality 

Again, results for large municipality are fine:  

```{r echo=FALSE, warning=FALSE}
population_complete %>% 
  filter(GMDNR == 261 & (age == "80+" | age == "<40")) %>% 
  bind_rows(population_mid_poi %>% 
              filter(GMDNR == 261 & (age == "80+" | age == "<40")) %>% 
              mutate(year = year - .5)) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = population_ext_poi)) +
  geom_point(aes(y = population_mid_poi), color = "red") +
  facet_wrap(age~sex, scales = "free")
```

### Small municipality 

Again, for small municipality we might end up with sth more wiggly.  

```{r echo=FALSE, warning=FALSE}
population_complete %>% 
  filter(GMDNR == 389 & (age == "80+" | age == "<40")) %>% 
  bind_rows(population_mid_poi %>% 
              filter(GMDNR == 389 & (age == "80+" | age == "<40")) %>% 
              mutate(year = year - .5)) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = population_ext_poi)) +
  geom_point(aes(y = population_mid_poi), color = "red") +
  facet_wrap(age~sex, scales = "free")
```

## Deaths <-> population link

Prepared population file is merged to deaths dataset prepared in `02.Rmd`.  
**We use file based on place of residence.**  

```{r}
w_deaths_2015_2021_pop <- read_rds("data/BfS-closed/monthly_deaths/w_deaths_2015_2021_exp.Rds") %>% 
  left_join(population_mid_poi) 
```

```{r eval=FALSE, include=FALSE}
summary(w_deaths_2015_2021_pop$population_mid_poi)
```

## Deaths > population problem

```{r}
surplus <- w_deaths_2015_2021_pop %>% 
  filter(deaths > population_mid_poi) %>% 
  arrange(GMDNR, date) %>% 
  mutate(difference = population_mid_poi - deaths)
```

There are `r number(nrow(surplus))` strata from `r number(length(unique(surplus$GMDNR)))`  communities where count of deaths is larger than count of population. The difference is always 1 in plus over population 0.   

```{r echo=FALSE}
surplus %>% 
  select(-GMDNR, -date, -border, -starts_with("AR")) %>% 
  datatable()
```

**In all these cases population was increased by 1 to match the count of deaths!**  

```{r}
w_deaths_2015_2021_pop %<>% 
  mutate(population_mid_poi = if_else(deaths > population_mid_poi, deaths, population_mid_poi))
```

```{r eval=FALSE, include=FALSE}
# missing checks
w_deaths_2015_2021_exp <- read_rds("data/BfS-closed/monthly_deaths/w_deaths_2015_2021_exp.Rds")

missing1 <- w_deaths_2015_2021_exp %>% 
  anti_join(population) %>% 
  select(GMDNAME) %>% 
  distinct()

missing2 <- population_complete %>% 
  filter(year > 2014) %>% 
  anti_join(w_deaths_2015_2021_exp) %>% 
  select(GMDNAME) %>% 
  distinct()

rm(w_deaths_2015_2021_exp, missing1, missing2); gc()
```

```{r include=FALSE}
rm(surplus); gc()

write_rds(w_deaths_2015_2021_pop, "data/BfS-closed/monthly_deaths/w_deaths_2015_2021_pop.Rds")
write_rds(population_complete, "data/BfS/monthly_deaths/population_complete.Rds")
```

<!-- ----------------------------------------------------- -->

# Cartogram

2020 population counts (*ignoring age structure*) were used to derive cartograms.  

## Communities 1

```{r include=FALSE}
# prepared in 01.Rmd
gg21 <- read_rds("data/BfS/gg21.Rds") %>% select(GMDNR, GMDNAME)
se21 <- read_rds("data/BfS/se21.Rds") %>% select(GMDNR, GMDNAME)
kt21 <- read_rds("data/BfS/kt21.Rds") %>% select(KTNR, KTNAME)

st_gg21 <- read_rds("data/swisstopo/st_gg21.Rds") %>% 
  st_transform(crs = 2056) %>% 
  select(-GEM_TEIL)

carto_data <- 
  gg21 %>% 
  left_join(
    population %>% 
      filter(year == 2020) %>% 
      group_by(GMDNR) %>% 
      summarise(population = sum(population)) %>% 
      ungroup()
  ) %>% 
  relocate(geometry, .after = last_col())
```

```{r eval=FALSE}
carto_data %>% 
  select(-BZNR, -KTNR) %>% 
  st_write("data/carto/in_gg21.shp", delete_dsn = TRUE)

se21 %>% 
  select(GMDNR, GMDNAME) %>% 
  st_write("data/carto/in_se21.shp", delete_dsn = TRUE)

# crashing :/
# carto <- carto_data %>%
#   cartogram::cartogram_cont("population")

# write_rds(carto, "data/carto/carto.Rds")

carto_ncont <- carto_data %>% 
  cartogram::cartogram_ncont("population")

write_rds(carto_ncont, "data/carto/carto_ncont.Rds")

carto_dorling <- carto_data %>% 
  cartogram::cartogram_dorling("population")

write_rds(carto_dorling, "data/carto/carto_dorling.Rds")
```

```{r eval=FALSE, include=FALSE}
# checking on swisstopo
# carto_data <- 
#   st_gg21 %>% 
#   select(GMDNR) %>% 
#   left_join(
#     population %>% 
#       filter(year == 2020) %>% 
#       group_by(GMDNR) %>% 
#       summarise(population = sum(population)) %>% 
#       ungroup()
#   )

# crashing :/
# carto <- carto_data %>%
#   cartogram::cartogram_cont("population")
```

```{r eval=FALSE}
# ScapeToad version
# java -Xmx1g -jar "C:\Program Files\ScapeToad-v11\ScapeToad.jar"
```

```{r include=FALSE}
# carto <- read_rds("data/carto/carto.Rds")
carto_ncont <- read_rds("data/carto/carto_ncont.Rds")
carto_dorling <- read_rds("data/carto/carto_dorling.Rds")

# ScapeToad version
carto <- st_read("data/carto/out_gg21.shp")
carto_se <- st_read("data/carto/out_se21.shp")

tmap_mode("plot")
```

### 'Classic' cartogram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(carto) + 
  tm_polygons("population", 
              style = "bclust", n = 5,
              palette = "-RdYlGn",
              legend.show = TRUE) +
  tm_shape(carto_se) + 
  tm_polygons("dodgerblue", 
              legend.show = TRUE, border.col = NA, alpha = 0.5) +
  tm_layout(frame = FALSE)
```

### Noncontinuous cartogram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(kt21) + 
  tm_borders() + 
  tm_shape(carto_ncont) + 
  tm_fill("population", 
          style = "bclust", n = 5,
          palette = "-RdYlGn",
          legend.show = TRUE) +
  tm_layout(frame = FALSE)
```

### Dorling carotgram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(carto_dorling) + 
  tm_fill("population", 
          style = "bclust", n = 5,
          palette = "-RdYlGn",
          legend.show = TRUE) +
  tm_layout(frame = FALSE)
```

```{r include=FALSE}
rm(carto, carto_dorling, carto_ncont, carto_se); gc()
```

## Labour market regions

```{r include=FALSE}
# prepared in 01.Rmd
ar_21_cor <- read_rds("data/BfS/ar21.Rds") %>% select(-ARNAME)

st_ar_21 <- read_rds("data/swisstopo/st_ar21.Rds") %>% select(-ARNAME)
```

```{r eval=FALSE}
ar_carto_data <- 
  ar_21_cor %>% 
  left_join(
    population %>% 
      filter(year == 2020) %>% 
      group_by(GMDNR) %>% 
      summarise(population = sum(population)) %>% 
      ungroup() %>% 
      left_join(raum) %>% 
      group_by(ARNR, ARNAME) %>% 
      summarise(population = sum(population)) %>% 
      ungroup()     
  ) 

ar_carto <- ar_carto_data %>%
  cartogram::cartogram_cont("population", itermax = 50)

ar_carto_ncont <- ar_carto_data %>% 
  cartogram::cartogram_ncont("population")

ar_carto_dorling <- ar_carto_data %>% 
  cartogram::cartogram_dorling("population")

write_rds(ar_carto, "data/carto/ar_carto.Rds")
write_rds(ar_carto_ncont, "data/carto/ar_carto_ncont.Rds")
write_rds(ar_carto_dorling, "data/carto/ar_carto_dorling.Rds")
```

```{r include=FALSE}
ar_carto <- read_rds("data/carto/ar_carto.Rds")
ar_carto_ncont <- read_rds("data/carto/ar_carto_ncont.Rds")
ar_carto_dorling <- read_rds("data/carto/ar_carto_dorling.Rds")
```

### 'Classic' cartogram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(ar_carto) + 
  tm_polygons("population", 
              style = "bclust", n = 5,
              palette = "-RdYlGn",
              legend.show = TRUE) +
  tm_layout(frame = FALSE)
```

### Noncontinuous cartogram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(kt21) + 
  tm_borders() + 
  tm_shape(ar_carto_ncont) + 
  tm_fill("population", 
          style = "bclust", n = 5,
          palette = "-RdYlGn",
          legend.show = TRUE) +
  tm_layout(frame = FALSE)
```

### Dorling carotgram  

```{r echo=FALSE, message=FALSE, warning=FALSE}
tm_shape(ar_carto_dorling) + 
  tm_fill("population", 
          style = "bclust", n = 5,
          palette = "-RdYlGn",
          legend.show = TRUE) +
  tm_layout(frame = FALSE)
```

```{r include=FALSE}
rm(ar_carto, ar_carto_ncont, ar_carto_dorling); gc()
```

<!-- ----------------------------------------------------- -->

# Swiss-SEP

```{r}
sep3 <- read_rds("../SNC_Swiss-SEP2/FINAL/RDS/ssep3_user_geo.Rds") %>%
  select(gisid, ssep3, ssep3_d) %>% 
  st_transform(crs = 2056)
```

```{r eval=FALSE, include=FALSE}
# %>%
#   mutate(ssep3_d = factor(ssep3_d,
#                           levels = 1:10,
#                           labels = c("1st - lowest",
#                                      "2", "3", "4",
#                                      "5th decile",
#                                      "6", "7", "8", "9",
#                                      "10th - highest")))
```

Using `r number(nrow(sep3), big.mark = ",")` n'hoods from version 3.0:  

```{r echo=FALSE}
sep3 %>% 
  st_drop_geometry() %>% 
  frq(ssep3_d)
```

This is aggregated to the level of `r scales::number(length(unique(st_gg21$GMDNR)), big.mark = ",")` communities from swisstopo.

## STATPOP

```{r}
statpop2020 <- read_delim("data-raw/BfS-closed/STATPOP/statpop2020_220098p.zip", 
                          delim = ";", escape_double = FALSE, 
                          col_types = cols(STATYEAR = col_integer(), 
                                           SEX = col_integer(), 
                                           TYPEOFRESIDENCE = col_integer(), 
                                           POPULATIONTYPE = col_integer(), 
                                           AGE = col_integer(), 
                                           CLASSAGEFIVEYEARS = col_integer(), 
                                           NATIONALITYCATEGORY = col_integer(), 
                                           MAINRESIDENCECATEGORY = col_integer(), 
                                           GEOCOORDE = col_integer(), 
                                           GEOCOORDN = col_integer(), 
                                           INDIC_EGID = col_integer(), 
                                           statdate = col_date(format = "%d/%m/%Y")), 
                          trim_ws = TRUE) %>% 
  remove_empty(c("rows", "cols")) %>% clean_names()  

statpop2020_agg <- statpop2020 %>% 
  rename(egid = federalbuildingid) %>% 
  filter(typeofresidence == 1) %>% 
  filter(populationtype == 1) %>% 
  filter(mainresidencecategory == 1) %>% 
  filter(indic_egid == 1) %>% 
  select(-statyear, -statdate, 
         -typeofresidence, -populationtype, -mainresidencecategory,
         -indic_egid) %>% 
  group_by(egid, geocoorde, geocoordn) %>% 
  summarise(pop = n()) %>% 
  ungroup() %>% 
  st_as_sf(coords = c("geocoorde", "geocoordn"), 
           crs = 2056,
           remove = TRUE)
```

Using data from `STATPOP` **2020**.  

Dataset consists of `r scales::number(nrow(statpop2020), big.mark = ",")` individuals and `r scales::number(nrow(statpop2020_agg), big.mark = ",")` buildings. We selected individuals with type of residence *Hauptwohnsitz*, population type *Ständige Wohnbevölkerung*, main residency category *Nur ein Hauptwohnsitz* and with valid EGID building ID.  

The nearest building with SSEP was assigned for each of these building. The point dataset was then overlaid with community boundaries and summary measures of population based index were created and population level SEP was aggregated by community. 

```{r include=FALSE}
rm(statpop2020); gc()
```

## 'nhood based averages for communities

```{r eval=FALSE}
st_gg21 <- read_rds("data/swisstopo/st_gg21.Rds") %>% 
  st_transform(crs = 2056) %>% 
  select(GMDNR)

# # or with full version?
# st_gg21 <- st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1g21_01072021.shp",
#           as_tibble = TRUE)

ssep3_gem_21 <- 
  st_join(sep3, 
          st_gg21, 
          join = st_intersects) 

# tm_shape(gg21) +
#   tm_polygons() +
#   tm_shape(ssep3_gem_21 %>% filter(is.na(GMDNR))) +
#   tm_dots()

ssep3_gem_21_neigh <- ssep3_gem_21 %>% 
  st_drop_geometry() %>% 
  group_by(GMDNR) %>% 
  summarise(n = n(),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

ssep3_gem_21_neigh_geo <- inner_join(gg21, ssep3_gem_21_neigh) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(median_ssep3_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_d = factor(median_ssep3_d,
                                 levels = 1:10,
                                 labels = c("1st - lowest", 
                                            "2", "3", "4", 
                                            "5th decile", 
                                            "6", "7", "8", "9", 
                                            "10th - highest")))

write_rds(ssep3_gem_21_neigh_geo, "data/BfS-closed/SEP/ssep3_gem_21_neigh_geo.rds")
```

```{r include=FALSE}
ssep3_gem_21_neigh_geo <- read_rds("data/BfS-closed/SEP/ssep3_gem_21_neigh_geo.rds")
```

Watch out for small n! Here some examples with communities below 20 n'hoods

```{r echo=FALSE}
ssep3_gem_21_neigh_geo %>% 
  st_drop_geometry() %>% 
  select(GMDNR, GMDNAME, n) %>% 
  inner_join(st_drop_geometry(st_gg21)) %>% 
  select(-GMDNR) %>% 
  filter(n < 20) %>%
  arrange(n) %>% 
  datatable(rownames = FALSE, options = list(dom = 't'))
```

```{r eval=FALSE, include=FALSE}
ssep3_gem_21_neigh_geo %>%
  filter(n < 20) %>%
  qtm(borders = "red", fill = "red")
```

Final map using median index - bubbles scaled to number of 'nhoods within community.

```{r include=FALSE}
tmap_mode("view")
```

```{r eval=FALSE, include=FALSE}
frq(ssep3_gem_21_neigh_geo$median_ssep3_d)
```

```{r echo=FALSE}
# tm_shape(kt21) +
#   tm_borders() + 
tm_shape(ssep3_gem_21_neigh_geo) +
  tm_dots(size = "n", col = "median_ssep3_d", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

## Population based averages for communities

```{r eval=FALSE}
# join to sep3
statpop2020_agg_sep <- st_join(statpop2020_agg, sep3, join = st_nearest_feature)

# fails for unknown and unsolved reasons
nearest <- st_nearest_feature(statpop2020_agg, sep3)
statpop2020_agg_sep$dist3 <- st_distance(statpop2020_agg_sep, sep3[nearest, ], by_element = TRUE)
rm(nearest, statpop2020_agg); gc()
summary(statpop2020_agg_sep$dist3)

statpop2020_agg_sep_gem21 <- 
  st_join(statpop2020_agg_sep, st_gg21, join = st_intersects) %>%  
  relocate(egid, gisid, pop,
           ssep3, ssep3_d,
           GMDNR) 

write_rds(statpop2020_agg_sep_gem21, "data/BfS-closed/SEP/statpop2020_agg_sep_gem21.Rds")
```

```{r include=FALSE}
rm(statpop2020_agg); gc()

statpop2020_agg_sep_gem21 <- read_rds("data/BfS-closed/SEP/statpop2020_agg_sep_gem21.Rds") %>% 
  st_drop_geometry()
```

```{r}
ssep3_gem_21_pop <- statpop2020_agg_sep_gem21 %>% 
  select(GMDNR, ssep3, pop) %>% 
  uncount(pop) %>% 
  group_by(GMDNR) %>% 
  summarise(pop = n(),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

# left_join(gg21, ssep3_gem_21_pop) %>% 
#   filter(is.na(ssep3_median))

ssep3_gem_21_pop_geo <- left_join(st_gg21, ssep3_gem_21_pop) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(median_ssep3_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_d = factor(median_ssep3_d,
                                 levels = 1:10,
                                 labels = c("1st - lowest", 
                                            "2", "3", "4", 
                                            "5th decile", 
                                            "6", "7", "8", "9", 
                                            "10th - highest")))

write_rds(ssep3_gem_21_pop_geo, "data/BfS-closed/SEP/ssep3_gem_21_pop_geo.rds")
```

Final map using median index - bubbles scaled to number of people (STATPOP 2020)  

```{r eval=FALSE, include=FALSE}
frq(ssep3_gem_21_pop_geo$median_ssep3_d)
```

```{r echo=FALSE}
ssep3_gem_21_pop_geo %>% 
  tm_shape() +
  tm_dots(size = "pop", col = "median_ssep3_d", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

## Population based averages for labour market regions

```{r include=FALSE}
# using swisstopo due to bfs geodata errors :/
ar_21 <- read_rds("data/swisstopo/st_ar21.Rds") %>% 
  select(-ARNAME)
```

```{r}
ssep3_ar_21_pop <- statpop2020_agg_sep_gem21 %>% 
  select(GMDNR, ssep3, pop) %>% 
  left_join(raum) %>% 
  select(-GMDNR) %>% 
  uncount(pop) %>% 
  group_by(ARNR) %>% 
  summarise(pop = n(),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

# left_join(ar_21, ssep3_ar_21_pop) %>%
#   filter(is.na(ssep3_median))

ssep3_ar_21_pop_geo <- left_join(ar_21, ssep3_ar_21_pop) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(median_ssep3_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_d = factor(median_ssep3_d,
                                 levels = 1:10,
                                 labels = c("1st - lowest", 
                                            "2", "3", "4", 
                                            "5th decile", 
                                            "6", "7", "8", "9", 
                                            "10th - highest")))

write_rds(ssep3_ar_21_pop_geo, "data/BfS-closed/SEP/ssep3_ar_21_pop_geo.rds")
```

```{r include=FALSE}
rm(statpop2020_agg_sep_gem21); gc()
```

Final map using median index - bubbles scaled to number of people (2019)  

```{r eval=FALSE, include=FALSE}
frq(ssep3_ar_21_pop_geo$median_ssep3_d)
```

```{r echo=FALSE}
ssep3_ar_21_pop_geo %>% 
  tm_shape() +
  tm_dots(size = "pop", col = "median_ssep3_d", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

<!-- ----------------------------------------------------- -->

# Raumgliederungen 

Data from the [app](https://www.agvchapp.bfs.admin.ch/de/typologies/query). State as of `2021-07-01` to match spatial data nicely.  

```{r}
raum <- read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
                  skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  filter(! is.na(bfs_gde_nummer)) %>% 
  rename(GMDNR = bfs_gde_nummer,
         GMDNAME = gemeindename,
         KTNAME = kanton,
         BZNR = bezirks_nummer,
         BZNAME = bezirksname) %>% 
  select(GMDNR, GMDNAME, KTNAME, BZNR, BZNAME, 
         stadtische_landliche_gebiete, sprachgebiete,
         urbanisierungsgrad_2011_degurba_eurostat) %>% 
  mutate(
    r_urban1 = case_when(
      stadtische_landliche_gebiete == 1 ~  "Urban",
      stadtische_landliche_gebiete == 2 ~  "Periurban",
      stadtische_landliche_gebiete == 3 ~  "Rural",
      TRUE ~  ""),
    r_urban2 = case_when(
      urbanisierungsgrad_2011_degurba_eurostat == 1 ~  "Dense",
      urbanisierungsgrad_2011_degurba_eurostat == 2 ~  "Medium",
      urbanisierungsgrad_2011_degurba_eurostat == 3 ~  "Low",
      TRUE ~  ""),
    r_lang = case_when(
      sprachgebiete == 1 ~  "German",
      sprachgebiete == 2 ~  "French",
      sprachgebiete == 3 ~  "Italian",
      sprachgebiete == 4 ~  "Romansh",
      TRUE ~  "")
  ) %>% 
  select(-stadtische_landliche_gebiete, -sprachgebiete,
         -urbanisierungsgrad_2011_degurba_eurostat)
```

```{r include=FALSE}
stopifnot(nrow(anti_join(raum, gg21)) == 0)

gg21_merged <- gg21 %>% 
  left_join(raum) %>% 
  relocate(geometry, .after = last_col())

tmap_mode("plot")
```

## Urbanization 1 

```{r echo=FALSE}
frq(raum, r_urban1)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban1")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Urbanization 2 

Using [DEGURBA](https://ec.europa.eu/eurostat/web/degree-of-urbanisation/background).  

```{r echo=FALSE}
frq(raum, r_urban2)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban2", palette = "-Set3")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Language region

```{r echo=FALSE}
frq(raum, r_lang)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_lang")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Language region 2021"
  )
```

```{r include=FALSE}
# final link
w_deaths_2015_2021_pop %<>% 
  left_join(ssep3_gem_21_pop_geo %>% 
              st_drop_geometry() %>% 
              select(-pop)) %>% 
  left_join(gg21_merged %>% 
              st_drop_geometry() %>% 
              select(-GMDNAME, -KTNAME, -BZNR, -BZNAME)
  )

write_rds(w_deaths_2015_2021_pop, "data/BfS-closed/monthly_deaths/w_deaths_2015_2021_pop.Rds")

w_deaths_2015_2021_ar_pop %>% 
  left_join(
    read_rds("data/BfS/raum.Rds") %>% 
      select(ARNR, border)
  ) %>% 
  left_join(ssep3_ar_21_pop_geo %>% 
              st_drop_geometry() %>% 
              select(-pop)
  )

write_rds(w_deaths_2015_2021_ar_pop, "data/BfS/w_deaths_2015_2021_ar_pop.Rds")
```

```{r eval=FALSE, include=FALSE}
# unlink("data/BfS-closed/w_deaths_2015_2021_exp.Rds")
# unlink("data/BfS-closed/w_deaths_2015_2021_ar.Rds")
```

<!-- ----------------------------------------------------- -->

# Voting

Data from `swissdd` [package](https://github.com/politanch/swissdd).    

Linked to municipality boundaries from `2022-01-01`.  

```{r}
st_gg22 <- read_rds("data/swisstopo/st_gg22.Rds")
```

## June vote

> Bundesgesetz vom 25.09.2020 über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)

### Data 

```{r}
covid_jun <- get_nationalvotes(votedates = "2021-06-13", 
                               geolevel = "municipality") %>% 
  filter(name == "Bundesgesetz über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)") %>% 
  select(-name, -id)
```

```{r echo=FALSE, include=FALSE}
# Votes from abroad are excluded. 
# covid_jun %>% 
#   filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
#   select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)

covid_jun %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(GMDNR = as.numeric(mun_id)) %>% 
  relocate(GMDNR)
```

Dataset consists of `r scales::number(length(unique(covid_jun$mun_id)), big.mark = ",")` communities.

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-06-13", 
                   vote_id = 6430, geolevel = "municipality")
```

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_jun_gem <- st_gg22 %>%  
  left_join(covid_jun)
```

There are few communities that exist on the map but do not exist in the voting dataset:   

```{r echo=FALSE}
covid_jun_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(GMDNR, GMDNAME)
```

```{r include=FALSE}
write_rds(covid_jun, "data/voting/covid_jun.Rds")
write_rds(covid_jun_gem, "data/voting/covid_jun_gem.Rds")
```

## November vote

> Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)  

### Data 

```{r}
covid_nov <- get_nationalvotes(votedates = "2021-11-28", 
                               geolevel = "municipality") %>% 
  filter(name == "Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)") %>% 
  select(-name, -id)
```

```{r echo=FALSE, include=FALSE}
# Votes from abroad are excluded. 
# covid_nov %>% 
#   filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
#   select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)

covid_nov %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(GMDNR = as.numeric(mun_id)) %>% 
  relocate(GMDNR)
```

Dataset consists of `r scales::number(length(unique(covid_nov$mun_id)), big.mark = ",")` communities.

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-11-28", 
                   vote_id = 6500, geolevel = "municipality")
```

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_nov_gem <- st_gg22 %>%  
  left_join(covid_nov)
```

There are again few communities that exist on the map but do not exist in the voting dataset:  

```{r echo=FALSE}
covid_nov_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(GMDNR, GMDNAME)
```

```{r include=FALSE}
write_rds(covid_nov, "data/voting/covid_nov.Rds")
write_rds(covid_nov_gem, "data/voting/covid_nov_gem.Rds")
```